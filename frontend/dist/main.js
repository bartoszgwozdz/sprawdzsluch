(()=>{var B=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var S=B(()=>{var L=["/assets/partials/modal-intro.html","/assets/partials/modal-preparation.html","/assets/partials/modal-test-1.html","/assets/partials/modal-test-2.html","/assets/partials/modal-test-3.html","/assets/partials/modal-results.html"],a=0,r=document.getElementById("hearing-modal"),m=document.getElementById("modal-content"),C=document.getElementById("modal-close");function y(){T(),a=0,u(a),r.classList.add("show")}var I=document.getElementById("start-test-btn");I&&I.addEventListener("click",y);C.onclick=()=>{a>=1?(document.getElementById("confirm-exit-modal").classList.add("show"),l(!0)):r.classList.remove("show")};function T(){if(document.getElementById("modal-scroll-styles"))return;let e=document.createElement("style");e.id="modal-scroll-styles",e.textContent=`
        #hearing-modal .modal-container {
            max-height: 90vh;
            overflow-y: auto;
        }
        
        #modal-content {
            overflow-y: visible;
            max-height: none;
        }
        
        /* Style do obs\u0142ugi mobile */
        @media (max-width: 768px) {
            #hearing-modal .modal-container {
                max-height: 85vh;
            }
        }
    `,document.head.appendChild(e)}T();function u(e){let t=r.querySelector(".modal-container");e===5?(t.classList.remove("standard-width"),t.classList.add("wide-width"),t.style.overflowY="auto",t.style.maxHeight="90vh"):(t.classList.remove("wide-width"),t.classList.add("standard-width"),t.style.maxHeight=""),fetch(L[e]).then(n=>n.text()).then(n=>{let o=n.match(/<body[^>]*>([\s\S]*?)<\/body>/i);if(m.innerHTML=o?o[1]:n,e===0){let s=document.getElementById("understand-button");s&&(s.onclick=()=>{a++,u(a)})}else if(e===1){let s=document.getElementById("headphones-checkbox"),i=document.getElementById("start-test-button");s&&i&&(i.disabled=!0,s.onchange=()=>{i.disabled=!s.checked},i.onclick=()=>{window.hearingTestInstance&&window.hearingTestInstance.unlockAudio(),a++,u(a)})}else e===2?(window.hearingTestInstance.initialize("hear-button","test-instruction","sound-wave-canvas"),window.hearingTestInstance.startAdjusting1kHz(),document.getElementById("hear-button").onclick=()=>{window.hearingTestInstance.recordHearing(),setTimeout(()=>{a++,u(a)},500)}):e===3?(window.hearingTestInstance.initialize("hear-button","test-instruction","sound-wave-canvas"),window.hearingTestInstance.findMaxFrequency(),document.getElementById("hear-button").onclick=()=>{window.hearingTestInstance.recordHearing(),setTimeout(()=>{a++,u(a)},500)}):e===4?(window.hearingTestInstance.initialize("hear-button","test-instruction","sound-wave-canvas"),window.hearingTestInstance.startRandomFrequencyTest(),window.addEventListener("randomTestCompleted",()=>{if(console.log('Event "randomTestCompleted" received. Advancing to results page.'),window.hearingTestInstance){let s={testId:"TEST-"+Date.now(),hearingLevels:window.hearingTestInstance.hearingLevels||[],maxAudibleFrequency:window.hearingTestInstance.maxAudibleFrequency||2e4,timestamp:new Date().toISOString()};localStorage.setItem("hearingTestResults",JSON.stringify(s))}r&&r.classList.remove("show"),window.location.href="/results/"},{once:!0}),document.getElementById("hear-button").onclick=()=>{window.hearingTestInstance.recordHearing()}):e===5&&fetch("/assets/partials/modal-results-part.html").then(s=>s.text()).then(s=>{let i=s.match(/<body[^>]*>([\s\S]*?)<\/body>/i),h=i?i[1]:s,f=s.match(/<style>([\s\S]*?)<\/style>/i),x=f?f[1]:"";if(x){let g=document.createElement("style");g.textContent=x,m.appendChild(g)}m.innerHTML+=h;let b=document.getElementById("finish-button");b&&(b.onclick=()=>r.classList.remove("show"));let E=document.getElementById("paymentForm");E&&E.addEventListener("submit",async g=>{g.preventDefault();let k=document.getElementById("email").value,v=document.querySelector('input[name="method"]:checked').value;try{let w=document.getElementById("buyBtn");w.disabled=!0,w.textContent="Przetwarzanie...";let c=await fetch("/api/payments/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userEmail:k,testId:"TEST-"+Math.floor(Math.random()*1e6),paymentMethod:v,testResults:window.hearingTestInstance.hearingLevels})});if(!c.ok)throw new Error(`B\u0142\u0105d HTTP: ${c.status}`);let d=await c.json();if(d.redirectUrl)window.location.href=d.redirectUrl;else throw new Error("Brak URL przekierowania w odpowiedzi.")}catch(w){console.error("B\u0142\u0105d podczas przetwarzania p\u0142atno\u015Bci:",w);let c=document.getElementById("statusMessage");c.textContent="Wyst\u0105pi\u0142 b\u0142\u0105d podczas przetwarzania p\u0142atno\u015Bci. Spr\xF3buj ponownie.",c.style.display="block",c.className="status error";let d=document.getElementById("buyBtn");d.disabled=!1,d.textContent="Kup raport PDF za 24,99 z\u0142"}}),setTimeout(()=>{t.scrollTop=0,M()},100)}).catch(s=>{console.error("Error loading results part:",s),m.innerHTML='<p class="p-4 text-red-500">Wyst\u0105pi\u0142 b\u0142\u0105d podczas \u0142adowania wynik\xF3w. Spr\xF3buj ponownie.</p>'})}).catch(n=>{console.error("Error loading step:",n),m.innerHTML='<p class="p-4 text-red-500">Could not load content. Please try again.</p>'})}function l(e){a>=2&&a<=4&&window.hearingTestInstance&&(e?(window.hearingTestInstance.pauseAudio(),console.log("Test audio paused")):(window.hearingTestInstance.resumeAudio(),console.log("Test audio resumed")))}r.addEventListener("mousedown",e=>{if(e.target===r)if(a>=1){let t=document.getElementById("confirm-exit-modal");t.classList.add("show"),l(!0);let n=document.getElementById("confirm-exit-yes"),o=document.getElementById("confirm-exit-no");n&&(n.onclick=function(){window.hearingTestInstance&&(window.hearingTestInstance.stopAudio(),console.log("Test audio stopped permanently")),t.classList.remove("show"),r.classList.remove("show")}),o&&(o.onclick=function(){t.classList.remove("show"),l(!1)})}else r.classList.remove("show")});var p=document.getElementById("confirm-exit-modal");p.addEventListener("mousedown",e=>{e.target===p&&(p.classList.remove("show"),l(!1))});document.addEventListener("keydown",e=>{if(r.classList.contains("show")&&e.key==="Escape"){let t=document.getElementById("confirm-exit-modal");t.classList.contains("show")?(t.classList.remove("show"),l(!1)):a>=1?(t.classList.add("show"),l(!0)):r.classList.remove("show")}});fetch("/assets/js/hearing-test.js").then(e=>e.text()).then(e=>{let t=document.createElement("script");t.textContent=e,document.head.appendChild(t)});fetch("/assets/partials/header.html").then(e=>e.text()).then(e=>{let t=document.getElementById("main-header");t&&(t.innerHTML=e);let n=document.getElementById("start-test-btn-header");n&&n.addEventListener("click",y);let o=document.querySelector(".mobile-menu-btn"),s=document.querySelector(".mobile-menu");if(o&&s){let i=o.querySelector(".material-icons");o.addEventListener("click",()=>{s.classList.toggle("is-open"),s.classList.contains("is-open")?i.textContent="close":i.textContent="menu"});let h=document.getElementById("start-test-btn-mobile");h&&h.addEventListener("click",()=>{s.classList.remove("is-open"),i&&(i.textContent="menu"),y()})}});fetch("/assets/partials/footer.html").then(e=>e.text()).then(e=>{let t=document.getElementById("main-footer");t&&(t.innerHTML=e)});function z(){return new Promise((e,t)=>{if(typeof Chart<"u"){e();return}let n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/chart.js",n.onload=()=>{let o=document.createElement("script");o.src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation",o.onload=e,o.onerror=t,document.head.appendChild(o)},n.onerror=t,document.head.appendChild(n)})}function M(){z().then(()=>{setTimeout(()=>{let t=document.getElementById("hearingRange");if(!t){console.error("Nie znaleziono elementu canvas dla wykresu");return}if(!window.hearingTestInstance||!window.hearingTestInstance.hearingLevels){console.error("Brak wynik\xF3w testu s\u0142uchu");return}try{let n;if(Chart.instances){for(let s=0;s<Chart.instances.length;s++)if(Chart.instances[s].canvas.id==="hearingRange"){n=Chart.instances[s];break}}else Chart.getChart&&(n=Chart.getChart(t));n||(console.log("Tworzenie nowego wykresu zakresu s\u0142uchu"),n=new Chart(t,{type:"line",data:{labels:[20,50,100,200,500,1e3,2e3,5e3,1e4,2e4],datasets:[{label:"Baseline",data:new Array(10).fill(0),borderColor:"transparent",pointRadius:0}]},options:{responsive:!0,scales:{x:{type:"logarithmic",min:100,max:2e4,ticks:{callback:s=>s>=1e3?s/1e3+" kHz":s+" Hz"}},y:{display:!1,min:0,max:1}},plugins:{legend:{display:!1},annotation:{annotations:{hearingRange:{type:"box",xMin:100,xMax:13e3,yMin:0,yMax:1,backgroundColor:"rgba(34,197,94,0.25)",borderWidth:0},maxLine:{type:"line",xMin:13e3,xMax:13e3,borderColor:"#22c55e",borderWidth:2,borderDash:[4,4],label:{display:!0,content:"Tw\xF3j maksymalny zakres s\u0142yszalny",position:"start",yAdjust:-20,backgroundColor:"rgba(34,197,94,0.9)",color:"#fff",font:{size:12,weight:"600"},padding:6,borderRadius:6}}}}}}}));let o=window.hearingTestInstance.maxAudibleFrequency||2e4;if(n.options.plugins&&n.options.plugins.annotation&&n.options.plugins.annotation.annotations){n.options.plugins.annotation.annotations.hearingRange.xMax=o,n.options.plugins.annotation.annotations.maxLine.xMin=o,n.options.plugins.annotation.annotations.maxLine.xMax=o;let s=(o/1e3).toFixed(1);n.options.plugins.annotation.annotations.maxLine.label.content=`Tw\xF3j maksymalny zakres s\u0142yszalny: ${s} kHz`}n.options.scales.x.min=100,n.options.scales.x.max=Math.max(o+2e3,2e4),n.update(),console.log("Wykres zakresu s\u0142uchu zaktualizowany, maks. cz\u0119stotliwo\u015B\u0107:",o)}catch(n){console.error("B\u0142\u0105d podczas aktualizacji wykresu:",n)}},300),document.getElementById("results-container")&&window.hearingTestInstance&&typeof window.hearingTestInstance.displayResults=="function"&&window.hearingTestInstance.displayResults("results-container")}).catch(e=>{console.error("B\u0142\u0105d \u0142adowania Chart.js:",e)})}});S();})();
